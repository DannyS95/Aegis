server {
  # Listen on HTTP port 80 (IPv4 and IPv6) for incoming requests
  listen 80;
  listen [::]:80;

  # Catch-all server name since this proxy is fronting a single backend
  server_name _;

  # Forward original request metadata so the Nest app can see caller details
  proxy_set_header Host $host;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme;

  # Protect token issuance with Basic auth before proxying to the backend
  location /auth/token {
    auth_basic "Internal token issuance";
    auth_basic_user_file /etc/nginx/.htpasswd;

    proxy_pass http://backend:3000/auth/token;
    proxy_http_version 1.1;
    proxy_set_header Connection "";
  }

  # Default proxy route for all other traffic (no extra auth)
  location / {
    proxy_pass http://backend:3000;
    proxy_http_version 1.1;
    proxy_set_header Connection "";
  }
}
